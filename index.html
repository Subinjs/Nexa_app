<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEXA Price Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d4ed8">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:#f8fafc}
header{background:#1d4ed8;color:#fff;padding:20px}
.container{max-width:1400px;margin:auto;padding:20px}
.controls{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:center}
.selects{display:flex;gap:12px}
.btn-group{display:flex;gap:8px}
select,button{padding:14px;font-size:16px;border-radius:10px;border:1px solid #cbd5e1}
button{background:#1d4ed8;color:#fff;font-weight:600;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:12px;border-bottom:1px solid #e5e7eb}
th{background:#1e40af;color:#fff;text-align:left}
.onroad{background:#047857!important;color:#fff;font-size:18px;font-weight:700}
@media(max-width:900px){.controls{grid-template-columns:1fr}}
.compare-list{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.compare-item{background:#fff;border:1px solid #cbd5e1;padding:8px 10px;border-radius:8px;display:flex;gap:8px;align-items:center}
.compare-item button{background:#ef4444;border:none;padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer}
.compare-panel{margin-top:20px}
.best{background:#d1fae5} /* green highlight for best */
.note{color:#374151;margin-top:6px}
.small{font-size:13px;color:#6b7280}
.toggle-tabs{display:flex;gap:0;margin-top:16px;border-radius:8px;overflow:hidden;border:1px solid #cbd5e1;width:fit-content}
.toggle-tabs button{border:none;border-radius:0;padding:10px 20px;background:#fff;color:#1d4ed8;font-weight:500;cursor:pointer;transition:all 0.2s}
.toggle-tabs button.active{background:#1d4ed8;color:#fff}
.toggle-tabs button:hover:not(.active){background:#e0e7ff}
.specs-card{background:#fff;border:1px solid #cbd5e1;border-radius:10px;padding:16px;margin-top:16px}
.specs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
.spec-item{padding:8px;background:#f8fafc;border-radius:6px}
.spec-label{font-size:12px;color:#6b7280;font-weight:500}
.spec-value{font-size:15px;color:#111827;font-weight:600;margin-top:2px}
.highlight-badge{display:inline-block;background:#10b981;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:6px}
</style>
</head>
<body>
<header>
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
  <div>
    <h1>üöó NEXA Price Explorer</h1>
    <p>Free ‚Ä¢ Installable ‚Ä¢ Compare Ready ‚Ä¢ <span style="color:#fbbf24;">January 2026 Offers Active</span></p>
  </div>
</div>
</header>

<div class="container">
  <div class="controls">
    <div class="selects">
      <select id="model" aria-label="Select car model"><option value="">Select Model</option></select>
      <select id="variant" aria-label="Select car variant"><option value="">Select Variant</option></select>
    </div>

    <div class="btn-group">
      <button id="showBtn">Show Price</button>
      <button id="addCompareBtn">Add to Compare</button>
      <button id="compareNowBtn">Compare Now</button>
      <button id="waShareBtn" style="background:#25d366;color:#fff;">Share via WhatsApp</button>
    </div>
  </div>

  <div class="compare-list" id="compareList" aria-live="polite"></div>
  <div id="out"></div>
  <div id="compareOut" class="compare-panel"></div>
  <p class="note small">Tip: select a model, choose a variant, then "Add to Compare". You can compare variants across different models. Lowest costs are highlighted in green.</p>
  <p class="note small" style="color:#059669;font-weight:600;">üéâ January 2026 Offers Applied! Consumer offers and retail support are automatically deducted from prices.</p>
</div>

<script>
// WhatsApp Share Button Logic
document.getElementById('waShareBtn').onclick = function() {
  if (varSel.value === "" || !modelSel.value) {
    alert("Please select a model and variant first");
    return;
  }
  const v = DATA[varSel.value];
  const offer = getOfferForVariant(modelSel.value, v);
  let message = `Nexa Price Details\nModel: ${MODELS[modelSel.value].name}\nVariant: ${v.variant}\nEx-Showroom: ‚Çπ${v.ex_showroom.toLocaleString("en-IN")}`;
  if (offer) {
    message += `\nConsumer Offer: -‚Çπ${offer.consumer_offer.toLocaleString("en-IN")}\nRetail Support: -‚Çπ${offer.retail_support.toLocaleString("en-IN")}\nExchange Bonus: ‚Çπ${offer.exchange_bonus.toLocaleString("en-IN")}`;
    const discounted = v.ex_showroom - offer.consumer_offer - offer.retail_support;
    message += `\nDiscounted Ex-Showroom: ‚Çπ${discounted.toLocaleString("en-IN")}`;
  }
  message += `\nOn-Road Price: ‚Çπ${v.onroad ? v.onroad.toLocaleString("en-IN") : 'To be calculated'}`;
  const whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(message);
  window.open(whatsappUrl, '_blank');
};
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}

const modelSel = document.getElementById("model");
const varSel   = document.getElementById("variant");
const out      = document.getElementById("out");

// üîë EXACT mapping to your filenames
const MODELS = {
  "grand_vitara": {
    name: "Grand Vitara (6 Airbag)",
    file: "grand_vitara_6_airbag.json",
    features: "grand_vitara_features.json"
  },
  "xl6": {
    name: "XL6 (6 Airbag)",
    file: "new_xl6_6_airbag.json",
    features: "xl6_features.json"
  },
  "baleno": {
    name: "Baleno (6 Airbag)",
    file: "baleno_6_airbag.json",
    features: "baleno_features.json"
  },
  "fronx": {
    name: "Fronx (6 Airbag)",
    file: "new_fronx_6_airbag.json",
    features: "fronx_features.json"
  },
  "ignis": {
    name: "Ignis",
    file: "ignis.json",
    features: "ignis_features.json"
  },
  "ciaz": {
    name: "Ciaz",
    file: "ciaz.json",
    features: "ciaz_features.json"
  },
  "jimny": {
    name: "Jimny",
    file: "jimny.json",
    features: "jimny_features.json"
  },
  "invicto": {
    name: "Invicto",
    file: "invicto.json",
    features: "invicto_features.json"
  }
};

let DATA = [];
let FEATURES = null;
let OFFERS = null;

// Load January offers
async function loadOffers() {
  try {
    const res = await fetch('data/january_offers.json');
    OFFERS = await res.json();
  } catch (e) {
    console.error('Failed to load offers:', e);
  }
}
loadOffers();

// Function to match variant to offer
function getOfferForVariant(modelKey, variant) {
  if (!OFFERS || !OFFERS.models[modelKey]) return null;
  
  const offers = OFFERS.models[modelKey].offers;
  const variantUpper = variant.variant.toUpperCase();
  const fuelUpper = variant.fuel.toUpperCase();
  
  // Find the best matching offer
  for (const offer of offers) {
    // Check if variant pattern matches
    if (offer.variant_pattern === 'ALL') return offer;
    
    // For specific variant patterns
    const pattern = offer.variant_pattern.toUpperCase();
    
    // Check for Strong Hybrid variants
    if (offer.hybrid && offer.hybrid === 'STRONG HYBRID') {
      if (variantUpper.includes('STRONG HYBRID') && variantUpper.includes(pattern)) {
        return offer;
      }
      continue;
    }
    
    // Check for 4WD variants
    if (offer.drivetrain && offer.drivetrain === '4WD') {
      if (variantUpper.includes('4WD') && variantUpper.includes(pattern)) {
        return offer;
      }
      continue;
    }
    
    // Check for CNG variants
    if (pattern === 'CNG') {
      if (variantUpper.includes('CNG') || fuelUpper.includes('CNG')) {
        return offer;
      }
      continue;
    }
    
    // Check for Turbo variants (Fronx)
    if (pattern === 'TURBO') {
      if (variantUpper.includes('TURBO') || variantUpper.includes('1.0')) {
        return offer;
      }
      continue;
    }
    
    // Check for 1.2L variants (Fronx)
    if (pattern === '1.2') {
      if (variantUpper.includes('1.2')) {
        // Check transmission if specified
        if (offer.transmission) {
          if (fuelUpper.includes(offer.transmission) || variantUpper.includes(offer.transmission)) {
            return offer;
          }
        } else {
          return offer;
        }
      }
      continue;
    }
    
    // Check for Automatic/AT/AGS/AMT variants
    if (pattern === 'AUTOMATIC' || pattern === 'AT' || pattern === 'AGS' || pattern === 'AMT') {
      if (variantUpper.includes('AUTOMATIC') || fuelUpper.includes('AT') || fuelUpper === 'AT' || 
          fuelUpper === 'AGS' || variantUpper.includes('AGS') ||
          fuelUpper === 'AMT' || variantUpper.includes('AMT')) {
        return offer;
      }
      continue;
    }
    
    // Check for MT variants
    if (pattern === 'MT') {
      if (fuelUpper === 'MT' || variantUpper.includes('5MT') || variantUpper.includes(' MT')) {
        return offer;
      }
      continue;
    }
    
    // Check for Petrol MT variants (need to exclude CNG and Automatic)
    if (pattern === 'PETROL' && offer.transmission === 'MT') {
      if (variantUpper.includes('PETROL') && fuelUpper === 'MT' && !variantUpper.includes('CNG') && !variantUpper.includes('AUTOMATIC')) {
        return offer;
      }
      continue;
    }
    
    // Check for standard variants (SIGMA, DELTA, ZETA, ALPHA)
    if (variantUpper.includes(pattern)) {
      // For transmission-specific offers
      if (offer.transmission) {
        if (fuelUpper.includes(offer.transmission) || variantUpper.includes(offer.transmission)) {
          return offer;
        }
        continue;
      }
      
      // For fuel-specific offers
      if (offer.fuel) {
        if (fuelUpper.includes(offer.fuel)) {
          return offer;
        }
        continue;
      }
      
      // Default match
      return offer;
    }
  }
  
  return null;
}

// Populate model dropdown
Object.keys(MODELS).forEach(key => {
  const o = document.createElement("option");
  o.value = key;
  o.textContent = MODELS[key].name;
  modelSel.appendChild(o);
});

// Load variants when model changes
modelSel.addEventListener("change", async () => {
  varSel.innerHTML = `<option value="">Select Variant</option>`;
  out.innerHTML = "";
  DATA = [];
  FEATURES = null;

  if (!modelSel.value) return;

  try {
    // Load price data
    const res = await fetch(`data/${MODELS[modelSel.value].file}`);
    DATA = await res.json();

    // Load features data
    const featRes = await fetch(`data/${MODELS[modelSel.value].features}`);
    FEATURES = await featRes.json();

    DATA.forEach((v, i) => {
      const priceLabel =
        v.onroad && v.onroad > 0
          ? `‚Çπ${v.onroad.toLocaleString("en-IN")}`
          : "Price on request";

      const o = document.createElement("option");
      o.value = i;
      o.textContent = `${v.variant} ‚Äì ${priceLabel}`;
      varSel.appendChild(o);
    });
  } catch (e) {
    out.innerHTML = `<p style="color:red">Failed to load variants</p>`;
  }
});

// Compare list
let compareList = [];
const compareListDiv = document.getElementById("compareList");
const compareOutDiv = document.getElementById("compareOut");

// Show price breakup
document.getElementById("showBtn").addEventListener("click", () => {
  if (varSel.value === "") return;

  const v = DATA[varSel.value];
  
  // Get offer for this variant
  const offer = getOfferForVariant(modelSel.value, v);
  
  // Calculate discounted ex-showroom price
  const discountedExShowroom = offer 
    ? v.ex_showroom - offer.consumer_offer - offer.retail_support
    : v.ex_showroom;
  
  // Calculate discounted on-road price
  let discountedOnroad = v.onroad;
  if (offer && v.onroad > 0) {
    discountedOnroad = v.onroad - offer.consumer_offer - offer.retail_support;
  }

  const onroad = discountedOnroad && discountedOnroad > 0
      ? `‚Çπ${discountedOnroad.toLocaleString("en-IN")}`
      : "To be calculated";

  let specsHTML = '';
  if (FEATURES) {
    const eng = FEATURES.engine;
    const trans = FEATURES.transmission;
    const mil = FEATURES.mileage;
    
    // Smart variant matching function
    function findVariantFeatures(variantName, variantFeaturesObj) {
      if (!variantFeaturesObj) return {};
      
      // Try exact match first
      if (variantFeaturesObj[variantName]) {
        return variantFeaturesObj[variantName];
      }
      
      // Try fuzzy matching based on variant hierarchy
      const upper = variantName.toUpperCase();
      
      // Check for base variant names in order of priority
      const patterns = [
        { key: 'ALPHA+', variants: ['ALPHA\\+', 'ALPHA\\(O\\)'] },
        { key: 'ALPHA', variants: ['ALPHA'] },
        { key: 'ZETA+', variants: ['ZETA\\+', 'ZETA\\(O\\)'] },
        { key: 'ZETA', variants: ['ZETA'] },
        { key: 'DELTA+', variants: ['DELTA\\+', 'DELTA\\(O\\)'] },
        { key: 'DELTA', variants: ['DELTA'] },
        { key: 'SIGMA', variants: ['SIGMA'] }
      ];
      
      // Find matching base variant
      for (const pattern of patterns) {
        for (const variant of pattern.variants) {
          const regex = new RegExp(variant, 'i');
          if (regex.test(upper)) {
            // Check for special variants first
            if (upper.includes('TURBO')) {
              if (variantFeaturesObj['ALPHA+ TURBO'] && pattern.key === 'ALPHA+') return variantFeaturesObj['ALPHA+ TURBO'];
              if (variantFeaturesObj['ALPHA TURBO'] && pattern.key === 'ALPHA') return variantFeaturesObj['ALPHA TURBO'];
            }
            if (upper.includes('STRONG HYBRID') || upper.includes('INTELLIGENT HYBRID')) {
              if (variantFeaturesObj['ALPHA+ STRONG HYBRID']) return variantFeaturesObj['ALPHA+ STRONG HYBRID'];
              if (variantFeaturesObj['ZETA+ STRONG HYBRID']) return variantFeaturesObj['ZETA+ STRONG HYBRID'];
            }
            if (upper.includes('7STR') || upper.includes('7 STR')) {
              if (variantFeaturesObj[pattern.key + ' 7 STR']) return variantFeaturesObj[pattern.key + ' 7 STR'];
            }
            if (upper.includes('8STR') || upper.includes('8 STR')) {
              if (variantFeaturesObj[pattern.key + ' 8 STR']) return variantFeaturesObj[pattern.key + ' 8 STR'];
            }
            
            // Try base pattern with various suffixes
            const suffixes = [' PETROL', ' MT', ' AT', ' (AUTOMATIC) PETROL', ' AMT', ''];
            for (const suffix of suffixes) {
              if (variantFeaturesObj[pattern.key + suffix]) {
                return variantFeaturesObj[pattern.key + suffix];
              }
            }
          }
        }
      }
      
      return {};
    }
    
    // Get variant-specific features with smart matching
    const variantFeatures = findVariantFeatures(v.variant, FEATURES.variant_features);
    
    specsHTML = `
    <div class="specs-card">
      <h3 style="margin:0 0 12px 0;color:#1d4ed8">üîß ${v.variant} - Specifications & Features</h3>
      <div class="specs-grid">
        <div class="spec-item">
          <div class="spec-label">Engine</div>
          <div class="spec-value">${variantFeatures.engine || eng.displacement_text || eng.displacement}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Power</div>
          <div class="spec-value">${eng.power_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Torque</div>
          <div class="spec-value">${eng.torque_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Transmission</div>
          <div class="spec-value">${variantFeatures.transmission || trans.description}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Mileage (${mil.type || 'ARAI'})</div>
          <div class="spec-value">${variantFeatures.mileage || mil.mt || mil.hybrid || 'N/A'}</div>
        </div>
        ${variantFeatures.airbags ? `
        <div class="spec-item">
          <div class="spec-label">Safety - Airbags</div>
          <div class="spec-value"><strong>${variantFeatures.airbags}</strong></div>
        </div>` : ''}
        ${variantFeatures.touchscreen ? `
        <div class="spec-item">
          <div class="spec-label">Touchscreen</div>
          <div class="spec-value">${variantFeatures.touchscreen}</div>
        </div>` : ''}
        ${variantFeatures.speakers ? `
        <div class="spec-item">
          <div class="spec-label">Sound System</div>
          <div class="spec-value">${variantFeatures.speakers}</div>
        </div>` : ''}
        ${variantFeatures.camera ? `
        <div class="spec-item">
          <div class="spec-label">Camera</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.camera}</span></div>
        </div>` : ''}
        ${variantFeatures.sunroof ? `
        <div class="spec-item">
          <div class="spec-label">Sunroof</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.sunroof}</span></div>
        </div>` : ''}
        ${variantFeatures.alloy_wheels ? `
        <div class="spec-item">
          <div class="spec-label">Alloy Wheels</div>
          <div class="spec-value">${variantFeatures.alloy_wheels}</div>
        </div>` : ''}
        ${variantFeatures.climate_control ? `
        <div class="spec-item">
          <div class="spec-label">Climate Control</div>
          <div class="spec-value">${variantFeatures.climate_control}</div>
        </div>` : ''}
        ${variantFeatures.seating ? `
        <div class="spec-item">
          <div class="spec-label">Seating</div>
          <div class="spec-value"><strong>${variantFeatures.seating}</strong></div>
        </div>` : FEATURES.seating ? `
        <div class="spec-item">
          <div class="spec-label">Seating</div>
          <div class="spec-value">${FEATURES.seating}</div>
        </div>` : ''}
        ${variantFeatures.hybrid || FEATURES.hybrid ? `
        <div class="spec-item">
          <div class="spec-label">Hybrid</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.hybrid || FEATURES.hybrid.type}</span></div>
        </div>` : ''}
        ${variantFeatures['4wd'] || FEATURES.drivetrain ? `
        <div class="spec-item">
          <div class="spec-label">Drivetrain</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures['4wd'] || FEATURES.drivetrain.type}</span></div>
        </div>` : ''}
        ${variantFeatures.adas ? `
        <div class="spec-item">
          <div class="spec-label">ADAS</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.adas}</span></div>
        </div>` : ''}
      </div>
    </div>
    
    ${Object.keys(variantFeatures).length > 0 ? `
    <div class="specs-card" style="margin-top:16px">
      <h3 style="margin:0 0 12px 0;color:#1d4ed8">‚ú® Variant Highlights</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
        ${variantFeatures.esp ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì ESP</div>' : ''}
        ${variantFeatures.abs_ebd ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì ABS + EBD</div>' : ''}
        ${variantFeatures.hill_hold ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Hill Hold Assist</div>' : ''}
        ${variantFeatures.cruise_control ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Cruise Control</div>' : ''}
        ${variantFeatures.keyless_entry ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Keyless Entry</div>' : ''}
        ${variantFeatures.push_button_start ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Push Button Start</div>' : ''}
        ${variantFeatures.auto_headlamps ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Auto Headlamps</div>' : ''}
        ${variantFeatures.rear_parking_sensors ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Rear Parking Sensors</div>' : ''}
        ${variantFeatures.wireless_charger ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Wireless Charger</div>' : ''}
        ${variantFeatures.ventilated_seats ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Ventilated Seats</div>' : ''}
        ${variantFeatures.head_up_display ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Head-Up Display</div>' : ''}
        ${variantFeatures.ev_mode ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê EV Mode</div>' : ''}
      </div>
    </div>` : ''}`;
  }

  out.innerHTML = `
  ${specsHTML}
  <table>
    <tr><th>Variant</th><td>${v.variant}</td></tr>
    <tr><th>Fuel / Gear</th><td>${v.fuel}</td></tr>
    <tr><th>Ex-Showroom</th><td>‚Çπ${v.ex_showroom.toLocaleString("en-IN")}</td></tr>
    ${offer ? `
    <tr style="background:#fef3c7"><th>Consumer Offer</th><td>- ‚Çπ${offer.consumer_offer.toLocaleString("en-IN")}</td></tr>
    <tr style="background:#fef3c7"><th>Retail Support</th><td>- ‚Çπ${offer.retail_support.toLocaleString("en-IN")}</td></tr>
    <tr style="background:#d1fae5;font-weight:700"><th>Discounted Ex-Showroom</th><td>‚Çπ${discountedExShowroom.toLocaleString("en-IN")}</td></tr>
    ` : ''}
    <tr><th>Insurance</th><td>‚Çπ${v.insurance.toLocaleString("en-IN")}</td></tr>
    <tr><th>Road Tax</th><td>‚Çπ${v.road_tax.toLocaleString("en-IN")}</td></tr>
    <tr><th>Registration</th><td>‚Çπ${v.registration}</td></tr>
    <tr><th>Fastag</th><td>‚Çπ${v.fastag}</td></tr>
    <tr><th>Extended Warranty</th><td>‚Çπ${v.extended_warranty.toLocaleString("en-IN")}</td></tr>
    <tr><th>Accessories</th><td>‚Çπ${v.accessories.toLocaleString("en-IN")}</td></tr>
    <tr><th>NEXA Card</th><td>‚Çπ${v.nexa_card}</td></tr>
    ${v.tcs > 0 ? `<tr><th>TCS</th><td>‚Çπ${v.tcs.toLocaleString("en-IN")}</td></tr>` : ""}
    <tr class="onroad"><th>On-Road Price</th><td>${onroad}</td></tr>
    ${offer ? `
    <tr style="background:#e0f2fe"><th>Exchange Bonus</th><td>‚Çπ${offer.exchange_bonus.toLocaleString("en-IN")}</td></tr>
    <tr style="background:#e0f2fe"><th>Corporate/Rural Offer</th><td>‚Çπ${offer.corporate_offer.toLocaleString("en-IN")} / ‚Çπ${offer.rural_offer.toLocaleString("en-IN")}</td></tr>
    ` : ''}
  </table>
  `;
});

// Add to compare
document.getElementById("addCompareBtn").addEventListener("click", () => {
  if (varSel.value === "" || !modelSel.value) {
    alert("Please select both model and variant first");
    return;
  }

  const v = DATA[varSel.value];
  const modelName = MODELS[modelSel.value].name;
  
  // Check if already in list
  const exists = compareList.find(item => 
    item.model === modelName && item.variant.variant === v.variant
  );
  
  if (exists) {
    alert("This variant is already in your compare list");
    return;
  }

  compareList.push({
    model: modelName,
    modelKey: modelSel.value,
    variant: v
  });

  renderCompareList();
});

// Render compare list
function renderCompareList() {
  if (compareList.length === 0) {
    compareListDiv.innerHTML = "";
    return;
  }

  compareListDiv.innerHTML = compareList.map((item, idx) => `
    <div class="compare-item">
      <span>${item.model} - ${item.variant.variant}</span>
      <button onclick="removeFromCompare(${idx})">‚úï</button>
    </div>
  `).join("");
}

// Remove from compare
window.removeFromCompare = function(idx) {
  compareList.splice(idx, 1);
  renderCompareList();
  if (compareList.length === 0) {
    compareOutDiv.innerHTML = "";
  }
};

// Compare now
document.getElementById("compareNowBtn").addEventListener("click", async () => {
  if (compareList.length < 2) {
    alert("Please add at least 2 variants to compare");
    return;
  }

  // Load features for all models in compare list
  const featuresMap = {};
  for (const item of compareList) {
    if (!featuresMap[item.modelKey]) {
      try {
        const res = await fetch(`data/${MODELS[item.modelKey].features}`);
        featuresMap[item.modelKey] = await res.json();
      } catch (e) {
        featuresMap[item.modelKey] = null;
      }
    }
  }

  // Find min values for highlighting
  const fields = ['ex_showroom', 'insurance', 'road_tax', 'extended_warranty', 'accessories', 'onroad'];
  const minValues = {};
  
  fields.forEach(field => {
    const values = compareList
      .map(item => item.variant[field] || 0)
      .filter(val => val > 0);
    minValues[field] = values.length > 0 ? Math.min(...values) : 0;
  });

  const formatCell = (value, field) => {
    if (!value || value === 0) return "N/A";
    const formatted = `‚Çπ${value.toLocaleString("en-IN")}`;
    const isBest = minValues[field] > 0 && value === minValues[field];
    return `<td class="${isBest ? 'best' : ''}">${formatted}</td>`;
  };
  
  // Get offers for all variants in comparison
  const offersMap = {};
  compareList.forEach(item => {
    offersMap[item.modelKey + '_' + item.variant.variant] = getOfferForVariant(item.modelKey, item.variant);
  });
  
  // Check if any variant has offers
  const hasAnyOffers = Object.values(offersMap).some(offer => offer !== null);

  let tableHTML = `<table>
    <thead>
      <tr>
        <th>Details</th>
        ${compareList.map(item => `<th>${item.model}<br><small>${item.variant.variant}</small></th>`).join("")}
      </tr>
    </thead>
    <tbody>
      <tr><th>Fuel / Gear</th>${compareList.map(item => `<td>${item.variant.fuel}</td>`).join("")}</tr>
      <tr><th>Ex-Showroom</th>${compareList.map(item => formatCell(item.variant.ex_showroom, 'ex_showroom')).join("")}</tr>`;
      
  // Add offer rows if any variant has offers
  if (hasAnyOffers) {
    tableHTML += `
      <tr style="background:#fef3c7"><th>Consumer Offer</th>${compareList.map(item => {
        const offer = offersMap[item.modelKey + '_' + item.variant.variant];
        return offer ? `<td>- ‚Çπ${offer.consumer_offer.toLocaleString("en-IN")}</td>` : '<td>‚Äî</td>';
      }).join("")}</tr>
      <tr style="background:#fef3c7"><th>Retail Support</th>${compareList.map(item => {
        const offer = offersMap[item.modelKey + '_' + item.variant.variant];
        return offer ? `<td>- ‚Çπ${offer.retail_support.toLocaleString("en-IN")}</td>` : '<td>‚Äî</td>';
      }).join("")}</tr>
      <tr style="background:#d1fae5;font-weight:700"><th>Discounted Ex-Showroom</th>${compareList.map(item => {
        const offer = offersMap[item.modelKey + '_' + item.variant.variant];
        const discounted = offer ? item.variant.ex_showroom - offer.consumer_offer - offer.retail_support : item.variant.ex_showroom;
        return `<td>‚Çπ${discounted.toLocaleString("en-IN")}</td>`;
      }).join("")}</tr>`;
  }
  
  tableHTML += `
      <tr><th>Insurance</th>${compareList.map(item => formatCell(item.variant.insurance, 'insurance')).join("")}</tr>
      <tr><th>Road Tax</th>${compareList.map(item => formatCell(item.variant.road_tax, 'road_tax')).join("")}</tr>
      <tr><th>Registration</th>${compareList.map(item => `<td>‚Çπ${item.variant.registration}</td>`).join("")}</tr>
      <tr><th>Fastag</th>${compareList.map(item => `<td>‚Çπ${item.variant.fastag}</td>`).join("")}</tr>
      <tr><th>Extended Warranty</th>${compareList.map(item => formatCell(item.variant.extended_warranty, 'extended_warranty')).join("")}</tr>
      <tr><th>Accessories</th>${compareList.map(item => formatCell(item.variant.accessories, 'accessories')).join("")}</tr>
      <tr><th>NEXA Card</th>${compareList.map(item => `<td>‚Çπ${item.variant.nexa_card}</td>`).join("")}</tr>`;

  // Add TCS row if any variant has it
  const hasTCS = compareList.some(item => item.variant.tcs > 0);
  if (hasTCS) {
    tableHTML += `<tr><th>TCS</th>${compareList.map(item => `<td>${item.variant.tcs > 0 ? '‚Çπ' + item.variant.tcs.toLocaleString("en-IN") : 'N/A'}</td>`).join("")}</tr>`;
  }

  tableHTML += `<tr class="onroad"><th>On-Road Price</th>${compareList.map(item => {
    const offer = offersMap[item.modelKey + '_' + item.variant.variant];
    const discountedOnroad = offer && item.variant.onroad > 0
      ? item.variant.onroad - offer.consumer_offer - offer.retail_support
      : item.variant.onroad;
    return formatCell(discountedOnroad, 'onroad');
  }).join("")}</tr>`;
  
  // Add offer bonus rows if any variant has offers
  if (hasAnyOffers) {
    tableHTML += `
      <tr style="background:#e0f2fe"><th>Exchange Bonus</th>${compareList.map(item => {
        const offer = offersMap[item.modelKey + '_' + item.variant.variant];
        return offer ? `<td>‚Çπ${offer.exchange_bonus.toLocaleString("en-IN")}</td>` : '<td>‚Äî</td>';
      }).join("")}</tr>
      <tr style="background:#e0f2fe"><th>Corporate/Rural Offer</th>${compareList.map(item => {
        const offer = offersMap[item.modelKey + '_' + item.variant.variant];
        return offer ? `<td>‚Çπ${offer.corporate_offer.toLocaleString("en-IN")} / ‚Çπ${offer.rural_offer.toLocaleString("en-IN")}</td>` : '<td>‚Äî</td>';
      }).join("")}</tr>`;
  }
  
  tableHTML += `
    </tbody>
  </table>`;

  // Specifications comparison table
  let specsTableHTML = `<h3 style="margin:24px 0 12px 0;color:#1d4ed8">üìä Specifications Comparison</h3><table>
    <thead>
      <tr>
        <th>Specification</th>
        ${compareList.map(item => `<th>${item.model}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;

  // Engine specs
  specsTableHTML += `<tr><th>Engine Displacement</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.displacement || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Power</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.power_text || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Torque</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.torque_text || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Transmission</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.transmission?.description || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Mileage (ARAI)</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    const mileage = feat?.mileage?.mt || feat?.mileage?.hybrid || feat?.mileage?.at || 'N/A';
    return `<td>${mileage}</td>`;
  }).join("")}</tr>`;

  // Optional specs
  const hasHybrid = compareList.some(item => featuresMap[item.modelKey]?.hybrid);
  if (hasHybrid) {
    specsTableHTML += `<tr><th>Hybrid System</th>${compareList.map(item => {
      const feat = featuresMap[item.modelKey];
      return `<td>${feat?.hybrid?.type || '‚Äî'}</td>`;
    }).join("")}</tr>`;
  }

  const hasDrivetrain = compareList.some(item => featuresMap[item.modelKey]?.drivetrain);
  if (hasDrivetrain) {
    specsTableHTML += `<tr><th>Drivetrain</th>${compareList.map(item => {
      const feat = featuresMap[item.modelKey];
      return `<td>${feat?.drivetrain?.type || 'FWD'}</td>`;
    }).join("")}</tr>`;
  }

  specsTableHTML += `</tbody></table>`;

  compareOutDiv.innerHTML = specsTableHTML + '<h3 style="margin:24px 0 12px 0;color:#1d4ed8">üí∞ Price Comparison</h3>' + tableHTML;
  compareOutDiv.scrollIntoView({ behavior: 'smooth' });
});
</script>

</body>
</html>
