<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NEXA Price Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1d4ed8">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
body{margin:0;font-family:Segoe UI,Roboto,Arial,sans-serif;background:#f8fafc}
header{background:#1d4ed8;color:#fff;padding:20px}
.container{max-width:1400px;margin:auto;padding:20px}
.controls{display:grid;grid-template-columns:1fr 1fr auto;gap:12px;align-items:center}
.selects{display:flex;gap:12px}
.btn-group{display:flex;gap:8px}
select,button{padding:14px;font-size:16px;border-radius:10px;border:1px solid #cbd5e1}
button{background:#1d4ed8;color:#fff;font-weight:600;cursor:pointer}
table{width:100%;border-collapse:collapse;margin-top:20px}
th,td{padding:12px;border-bottom:1px solid #e5e7eb}
th{background:#1e40af;color:#fff;text-align:left}
.onroad{background:#047857!important;color:#fff;font-size:18px;font-weight:700}
@media(max-width:900px){.controls{grid-template-columns:1fr}}
.compare-list{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
.compare-item{background:#fff;border:1px solid #cbd5e1;padding:8px 10px;border-radius:8px;display:flex;gap:8px;align-items:center}
.compare-item button{background:#ef4444;border:none;padding:6px 8px;border-radius:6px;color:#fff;cursor:pointer}
.compare-panel{margin-top:20px}
.best{background:#d1fae5} /* green highlight for best */
.note{color:#374151;margin-top:6px}
.small{font-size:13px;color:#6b7280}
.toggle-tabs{display:flex;gap:0;margin-top:16px;border-radius:8px;overflow:hidden;border:1px solid #cbd5e1;width:fit-content}
.toggle-tabs button{border:none;border-radius:0;padding:10px 20px;background:#fff;color:#1d4ed8;font-weight:500;cursor:pointer;transition:all 0.2s}
.toggle-tabs button.active{background:#1d4ed8;color:#fff}
.toggle-tabs button:hover:not(.active){background:#e0e7ff}
.specs-card{background:#fff;border:1px solid #cbd5e1;border-radius:10px;padding:16px;margin-top:16px}
.specs-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:12px}
.spec-item{padding:8px;background:#f8fafc;border-radius:6px}
.spec-label{font-size:12px;color:#6b7280;font-weight:500}
.spec-value{font-size:15px;color:#111827;font-weight:600;margin-top:2px}
.highlight-badge{display:inline-block;background:#10b981;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;margin-left:6px}
</style>
</head>
<body>
<header>
<div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px;">
  <div>
    <h1>üöó NEXA Price Explorer</h1>
    <p>Free ‚Ä¢ Installable ‚Ä¢ Compare Ready</p>
  </div>
  <button onclick="window.location.href='features.html'" style="background:#10b981;padding:12px 24px;border-radius:8px;border:none;color:#fff;font-weight:600;cursor:pointer;font-size:14px;">View Features & Photos ‚Üí</button>
</div>
</header>

<div class="container">
  <div class="controls">
    <div class="selects">
      <select id="model" aria-label="Select car model"><option value="">Select Model</option></select>
      <select id="variant" aria-label="Select car variant"><option value="">Select Variant</option></select>
    </div>

    <div class="btn-group">
      <button id="showBtn">Show Price</button>
      <button id="addCompareBtn">Add to Compare</button>
      <button id="compareNowBtn">Compare Now</button>
    </div>
  </div>

  <div class="compare-list" id="compareList" aria-live="polite"></div>
  <div id="out"></div>
  <div id="compareOut" class="compare-panel"></div>
  <p class="note small">Tip: select a model, choose a variant, then "Add to Compare". You can compare variants across different models. Lowest costs are highlighted in green.</p>
</div>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js').catch(()=>{});
}

const modelSel = document.getElementById("model");
const varSel   = document.getElementById("variant");
const out      = document.getElementById("out");

// üîë EXACT mapping to your filenames
const MODELS = {
  "grand_vitara": {
    name: "Grand Vitara (6 Airbag)",
    file: "grand_vitara_6_airbag.json",
    features: "grand_vitara_features.json"
  },
  "xl6": {
    name: "XL6 (6 Airbag)",
    file: "new_xl6_6_airbag.json",
    features: "xl6_features.json"
  },
  "baleno": {
    name: "Baleno (6 Airbag)",
    file: "baleno_6_airbag.json",
    features: "baleno_features.json"
  },
  "fronx": {
    name: "Fronx (6 Airbag)",
    file: "new_fronx_6_airbag.json",
    features: "fronx_features.json"
  },
  "ignis": {
    name: "Ignis",
    file: "ignis.json",
    features: "ignis_features.json"
  },
  "ciaz": {
    name: "Ciaz",
    file: "ciaz.json",
    features: "ciaz_features.json"
  },
  "jimny": {
    name: "Jimny",
    file: "jimny.json",
    features: "jimny_features.json"
  },
  "invicto": {
    name: "Invicto",
    file: "invicto.json",
    features: "invicto_features.json"
  }
};

let DATA = [];
let FEATURES = null;

// Populate model dropdown
Object.keys(MODELS).forEach(key => {
  const o = document.createElement("option");
  o.value = key;
  o.textContent = MODELS[key].name;
  modelSel.appendChild(o);
});

// Load variants when model changes
modelSel.addEventListener("change", async () => {
  varSel.innerHTML = `<option value="">Select Variant</option>`;
  out.innerHTML = "";
  DATA = [];
  FEATURES = null;

  if (!modelSel.value) return;

  try {
    // Load price data
    const res = await fetch(`data/${MODELS[modelSel.value].file}`);
    DATA = await res.json();

    // Load features data
    const featRes = await fetch(`data/${MODELS[modelSel.value].features}`);
    FEATURES = await featRes.json();

    DATA.forEach((v, i) => {
      const priceLabel =
        v.onroad && v.onroad > 0
          ? `‚Çπ${v.onroad.toLocaleString("en-IN")}`
          : "Price on request";

      const o = document.createElement("option");
      o.value = i;
      o.textContent = `${v.variant} ‚Äì ${priceLabel}`;
      varSel.appendChild(o);
    });
  } catch (e) {
    out.innerHTML = `<p style="color:red">Failed to load variants</p>`;
  }
});

// Compare list
let compareList = [];
const compareListDiv = document.getElementById("compareList");
const compareOutDiv = document.getElementById("compareOut");

// Show price breakup
document.getElementById("showBtn").addEventListener("click", () => {
  if (varSel.value === "") return;

  const v = DATA[varSel.value];

  const onroad =
    v.onroad && v.onroad > 0
      ? `‚Çπ${v.onroad.toLocaleString("en-IN")}`
      : "To be calculated";

  let specsHTML = '';
  if (FEATURES) {
    const eng = FEATURES.engine;
    const trans = FEATURES.transmission;
    const mil = FEATURES.mileage;
    
    // Get variant-specific features if available
    const variantFeatures = FEATURES.variant_features?.[v.variant] || {};
    
    specsHTML = `
    <div class="specs-card">
      <h3 style="margin:0 0 12px 0;color:#1d4ed8">üîß ${v.variant} - Specifications & Features</h3>
      <div class="specs-grid">
        <div class="spec-item">
          <div class="spec-label">Engine</div>
          <div class="spec-value">${variantFeatures.engine || eng.displacement_text || eng.displacement}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Power</div>
          <div class="spec-value">${eng.power_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Torque</div>
          <div class="spec-value">${eng.torque_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Transmission</div>
          <div class="spec-value">${variantFeatures.transmission || trans.description}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Mileage (${mil.type || 'ARAI'})</div>
          <div class="spec-value">${variantFeatures.mileage || mil.mt || mil.hybrid || 'N/A'}</div>
        </div>
        ${variantFeatures.airbags ? `
        <div class="spec-item">
          <div class="spec-label">Safety - Airbags</div>
          <div class="spec-value"><strong>${variantFeatures.airbags}</strong></div>
        </div>` : ''}
        ${variantFeatures.touchscreen ? `
        <div class="spec-item">
          <div class="spec-label">Touchscreen</div>
          <div class="spec-value">${variantFeatures.touchscreen}</div>
        </div>` : ''}
        ${variantFeatures.speakers ? `
        <div class="spec-item">
          <div class="spec-label">Sound System</div>
          <div class="spec-value">${variantFeatures.speakers}</div>
        </div>` : ''}
        ${variantFeatures.camera ? `
        <div class="spec-item">
          <div class="spec-label">Camera</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.camera}</span></div>
        </div>` : ''}
        ${variantFeatures.sunroof ? `
        <div class="spec-item">
          <div class="spec-label">Sunroof</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.sunroof}</span></div>
        </div>` : ''}
        ${variantFeatures.alloy_wheels ? `
        <div class="spec-item">
          <div class="spec-label">Alloy Wheels</div>
          <div class="spec-value">${variantFeatures.alloy_wheels}</div>
        </div>` : ''}
        ${variantFeatures.climate_control ? `
        <div class="spec-item">
          <div class="spec-label">Climate Control</div>
          <div class="spec-value">${variantFeatures.climate_control}</div>
        </div>` : ''}
        ${variantFeatures.seating ? `
        <div class="spec-item">
          <div class="spec-label">Seating</div>
          <div class="spec-value"><strong>${variantFeatures.seating}</strong></div>
        </div>` : FEATURES.seating ? `
        <div class="spec-item">
          <div class="spec-label">Seating</div>
          <div class="spec-value">${FEATURES.seating}</div>
        </div>` : ''}
        ${variantFeatures.hybrid || FEATURES.hybrid ? `
        <div class="spec-item">
          <div class="spec-label">Hybrid</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.hybrid || FEATURES.hybrid.type}</span></div>
        </div>` : ''}
        ${variantFeatures['4wd'] || FEATURES.drivetrain ? `
        <div class="spec-item">
          <div class="spec-label">Drivetrain</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures['4wd'] || FEATURES.drivetrain.type}</span></div>
        </div>` : ''}
        ${variantFeatures.adas ? `
        <div class="spec-item">
          <div class="spec-label">ADAS</div>
          <div class="spec-value"><span class="highlight-badge">${variantFeatures.adas}</span></div>
        </div>` : ''}
      </div>
    </div>
    
    ${Object.keys(variantFeatures).length > 0 ? `
    <div class="specs-card" style="margin-top:16px">
      <h3 style="margin:0 0 12px 0;color:#1d4ed8">‚ú® Variant Highlights</h3>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
        ${variantFeatures.esp ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì ESP</div>' : ''}
        ${variantFeatures.abs_ebd ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì ABS + EBD</div>' : ''}
        ${variantFeatures.hill_hold ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Hill Hold Assist</div>' : ''}
        ${variantFeatures.cruise_control ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Cruise Control</div>' : ''}
        ${variantFeatures.keyless_entry ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Keyless Entry</div>' : ''}
        ${variantFeatures.push_button_start ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Push Button Start</div>' : ''}
        ${variantFeatures.auto_headlamps ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Auto Headlamps</div>' : ''}
        ${variantFeatures.rear_parking_sensors ? '<div style="padding:8px;background:#d1fae5;border-radius:6px">‚úì Rear Parking Sensors</div>' : ''}
        ${variantFeatures.wireless_charger ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Wireless Charger</div>' : ''}
        ${variantFeatures.ventilated_seats ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Ventilated Seats</div>' : ''}
        ${variantFeatures.head_up_display ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê Head-Up Display</div>' : ''}
        ${variantFeatures.ev_mode ? '<div style="padding:8px;background:#fef3c7;border-radius:6px">‚≠ê EV Mode</div>' : ''}
      </div>
    </div>` : ''}`;
        </div>
        <div class="spec-item">
          <div class="spec-label">Power</div>
          <div class="spec-value">${eng.power_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Torque</div>
          <div class="spec-value">${eng.torque_text}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Transmission</div>
          <div class="spec-value">${trans.description}</div>
        </div>
        <div class="spec-item">
          <div class="spec-label">Mileage (${mil.type})</div>
          <div class="spec-value">${mil.mt || mil.hybrid || 'N/A'}</div>
        </div>
        ${FEATURES.hybrid ? `
        <div class="spec-item">
          <div class="spec-label">Hybrid</div>
          <div class="spec-value">${FEATURES.hybrid.type}</div>
        </div>` : ''}
        ${FEATURES.drivetrain ? `
        <div class="spec-item">
          <div class="spec-label">Drivetrain</div>
          <div class="spec-value">${FEATURES.drivetrain.type}</div>
        </div>` : ''}
        ${FEATURES.seating ? `
        <div class="spec-item">
          <div class="spec-label">Seating</div>
          <div class="spec-value">${FEATURES.seating}</div>
        </div>` : ''}
      </div>
    </div>`;
  }

  out.innerHTML = `
  ${specsHTML}
  <table>
    <tr><th>Variant</th><td>${v.variant}</td></tr>
    <tr><th>Fuel / Gear</th><td>${v.fuel}</td></tr>
    <tr><th>Ex-Showroom</th><td>‚Çπ${v.ex_showroom.toLocaleString("en-IN")}</td></tr>
    <tr><th>Insurance</th><td>‚Çπ${v.insurance.toLocaleString("en-IN")}</td></tr>
    <tr><th>Road Tax</th><td>‚Çπ${v.road_tax.toLocaleString("en-IN")}</td></tr>
    <tr><th>Registration</th><td>‚Çπ${v.registration}</td></tr>
    <tr><th>Fastag</th><td>‚Çπ${v.fastag}</td></tr>
    <tr><th>Extended Warranty</th><td>‚Çπ${v.extended_warranty.toLocaleString("en-IN")}</td></tr>
    <tr><th>Accessories</th><td>‚Çπ${v.accessories.toLocaleString("en-IN")}</td></tr>
    <tr><th>NEXA Card</th><td>‚Çπ${v.nexa_card}</td></tr>
    ${v.tcs > 0 ? `<tr><th>TCS</th><td>‚Çπ${v.tcs.toLocaleString("en-IN")}</td></tr>` : ""}
    <tr class="onroad"><th>On-Road Price</th><td>${onroad}</td></tr>
  </table>
  `;
});

// Add to compare
document.getElementById("addCompareBtn").addEventListener("click", () => {
  if (varSel.value === "" || !modelSel.value) {
    alert("Please select both model and variant first");
    return;
  }

  const v = DATA[varSel.value];
  const modelName = MODELS[modelSel.value].name;
  
  // Check if already in list
  const exists = compareList.find(item => 
    item.model === modelName && item.variant.variant === v.variant
  );
  
  if (exists) {
    alert("This variant is already in your compare list");
    return;
  }

  compareList.push({
    model: modelName,
    modelKey: modelSel.value,
    variant: v
  });

  renderCompareList();
});

// Render compare list
function renderCompareList() {
  if (compareList.length === 0) {
    compareListDiv.innerHTML = "";
    return;
  }

  compareListDiv.innerHTML = compareList.map((item, idx) => `
    <div class="compare-item">
      <span>${item.model} - ${item.variant.variant}</span>
      <button onclick="removeFromCompare(${idx})">‚úï</button>
    </div>
  `).join("");
}

// Remove from compare
window.removeFromCompare = function(idx) {
  compareList.splice(idx, 1);
  renderCompareList();
  if (compareList.length === 0) {
    compareOutDiv.innerHTML = "";
  }
};

// Compare now
document.getElementById("compareNowBtn").addEventListener("click", async () => {
  if (compareList.length < 2) {
    alert("Please add at least 2 variants to compare");
    return;
  }

  // Load features for all models in compare list
  const featuresMap = {};
  for (const item of compareList) {
    if (!featuresMap[item.modelKey]) {
      try {
        const res = await fetch(`data/${MODELS[item.modelKey].features}`);
        featuresMap[item.modelKey] = await res.json();
      } catch (e) {
        featuresMap[item.modelKey] = null;
      }
    }
  }

  // Find min values for highlighting
  const fields = ['ex_showroom', 'insurance', 'road_tax', 'extended_warranty', 'accessories', 'onroad'];
  const minValues = {};
  
  fields.forEach(field => {
    const values = compareList
      .map(item => item.variant[field] || 0)
      .filter(val => val > 0);
    minValues[field] = values.length > 0 ? Math.min(...values) : 0;
  });

  const formatCell = (value, field) => {
    if (!value || value === 0) return "N/A";
    const formatted = `‚Çπ${value.toLocaleString("en-IN")}`;
    const isBest = minValues[field] > 0 && value === minValues[field];
    return `<td class="${isBest ? 'best' : ''}">${formatted}</td>`;
  };

  let tableHTML = `<table>
    <thead>
      <tr>
        <th>Details</th>
        ${compareList.map(item => `<th>${item.model}<br><small>${item.variant.variant}</small></th>`).join("")}
      </tr>
    </thead>
    <tbody>
      <tr><th>Fuel / Gear</th>${compareList.map(item => `<td>${item.variant.fuel}</td>`).join("")}</tr>
      <tr><th>Ex-Showroom</th>${compareList.map(item => formatCell(item.variant.ex_showroom, 'ex_showroom')).join("")}</tr>
      <tr><th>Insurance</th>${compareList.map(item => formatCell(item.variant.insurance, 'insurance')).join("")}</tr>
      <tr><th>Road Tax</th>${compareList.map(item => formatCell(item.variant.road_tax, 'road_tax')).join("")}</tr>
      <tr><th>Registration</th>${compareList.map(item => `<td>‚Çπ${item.variant.registration}</td>`).join("")}</tr>
      <tr><th>Fastag</th>${compareList.map(item => `<td>‚Çπ${item.variant.fastag}</td>`).join("")}</tr>
      <tr><th>Extended Warranty</th>${compareList.map(item => formatCell(item.variant.extended_warranty, 'extended_warranty')).join("")}</tr>
      <tr><th>Accessories</th>${compareList.map(item => formatCell(item.variant.accessories, 'accessories')).join("")}</tr>
      <tr><th>NEXA Card</th>${compareList.map(item => `<td>‚Çπ${item.variant.nexa_card}</td>`).join("")}</tr>`;

  // Add TCS row if any variant has it
  const hasTCS = compareList.some(item => item.variant.tcs > 0);
  if (hasTCS) {
    tableHTML += `<tr><th>TCS</th>${compareList.map(item => `<td>${item.variant.tcs > 0 ? '‚Çπ' + item.variant.tcs.toLocaleString("en-IN") : 'N/A'}</td>`).join("")}</tr>`;
  }

  tableHTML += `<tr class="onroad"><th>On-Road Price</th>${compareList.map(item => formatCell(item.variant.onroad, 'onroad')).join("")}</tr>
    </tbody>
  </table>`;

  // Specifications comparison table
  let specsTableHTML = `<h3 style="margin:24px 0 12px 0;color:#1d4ed8">üìä Specifications Comparison</h3><table>
    <thead>
      <tr>
        <th>Specification</th>
        ${compareList.map(item => `<th>${item.model}</th>`).join("")}
      </tr>
    </thead>
    <tbody>`;

  // Engine specs
  specsTableHTML += `<tr><th>Engine Displacement</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.displacement || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Power</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.power_text || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Torque</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.engine?.torque_text || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Transmission</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    return `<td>${feat?.transmission?.description || 'N/A'}</td>`;
  }).join("")}</tr>`;

  specsTableHTML += `<tr><th>Mileage (ARAI)</th>${compareList.map(item => {
    const feat = featuresMap[item.modelKey];
    const mileage = feat?.mileage?.mt || feat?.mileage?.hybrid || feat?.mileage?.at || 'N/A';
    return `<td>${mileage}</td>`;
  }).join("")}</tr>`;

  // Optional specs
  const hasHybrid = compareList.some(item => featuresMap[item.modelKey]?.hybrid);
  if (hasHybrid) {
    specsTableHTML += `<tr><th>Hybrid System</th>${compareList.map(item => {
      const feat = featuresMap[item.modelKey];
      return `<td>${feat?.hybrid?.type || '‚Äî'}</td>`;
    }).join("")}</tr>`;
  }

  const hasDrivetrain = compareList.some(item => featuresMap[item.modelKey]?.drivetrain);
  if (hasDrivetrain) {
    specsTableHTML += `<tr><th>Drivetrain</th>${compareList.map(item => {
      const feat = featuresMap[item.modelKey];
      return `<td>${feat?.drivetrain?.type || 'FWD'}</td>`;
    }).join("")}</tr>`;
  }

  specsTableHTML += `</tbody></table>`;

  compareOutDiv.innerHTML = specsTableHTML + '<h3 style="margin:24px 0 12px 0;color:#1d4ed8">üí∞ Price Comparison</h3>' + tableHTML;
  compareOutDiv.scrollIntoView({ behavior: 'smooth' });
});
</script>

</body>
</html>
